# Copilot instructions for hoverboard-firmware-hack-FOC

This file summarizes the essential knowledge an automated coding agent needs to be immediately productive in this repository.

High-level architecture
- Target: STM32F103 (STM32F103RCT6) family (some boards also support GD32F103). See `platformio.ini` and `Inc/stm32f1xx_hal_conf.h`.
- Project layout:
  - `Src/` — application C sources (entry point: `Src/main.c`, BLDC controller implementation in `Src/BLDC_controller.c`, autogenerated RTW hooks in several files)
  - `Inc/` — headers and configuration (`config.h`, `defines.h`, `BLDC_controller.h`)
  - `Drivers/` — HAL/CMSIS drivers and third-party libs
  - `Arduino/hoverserial/` — example host sketch used for serial command input
  - `docs/` — hardware schematics, pictures and notes

Key concepts and data flows
- Motor control uses a BLDC FOC controller implemented in `Src/BLDC_controller.c` with motor parameters in `Src/BLDC_controller_data.c`. Parameters are fixed-point.
- Inputs: ADC (potentiometers), USART (serial commands), PPM/PWM/IBUS and Wii Nunchuk variants. Variant selection is compile-time via `-D VARIANT_*` flags in `platformio.ini`.
- Outputs: PWM timers (`TIM_HandleTypeDef`), UARTs (feedback), and optional I2C LCD. Sideboards communicate over USART2/USART3 (see `Src/main.c` for sideboard handling and DMA-based UART transmit code).
- Safety and limits are applied in `config.h` and `defines.h` (timeouts, over-voltage, temperature cutoffs, enable/disable logic). Many features are guarded by `#ifdef` flags.

Build / flash / debug workflows (concrete)
- Primary build system: PlatformIO. `platformio.ini` defines multiple envs (one per VARIANT). The project uses `framework = stm32cube` and `platform = ststm32`.
- Typical commands (PowerShell):
  - Build a variant: `pio run -e VARIANT_USART` (replace env with chosen variant such as VARIANT_ADC, VARIANT_HOVERCAR, ...)
  - Upload (using ST-Link): `pio run -e VARIANT_USART -t upload`
  - Build + open monitor: `pio run -e VARIANT_USART; pio device monitor -p COM5 -b 115200`
  - To build all envs: `pio run -e VARIANT_ADC -e VARIANT_USART -e VARIANT_HOVERCAR` (or use `default_envs` in `platformio.ini`)
- Notes: `platformio.ini` sets `-g -ggdb` so `firmware.elf` is generated (useful for STM Studio / debugger and diagnostics). Upload tool and protocol use `stlink` by default.

Project-specific conventions & patterns
- Variant-first design: functionality changes via compile-time `-D VARIANT_*` macros, not runtime config. To add behavior, prefer adding a new `VARIANT_` or guarding code with `#ifdef VARIANT_*`.
- Fixed-point math: motor controller parameters and many filters are implemented in fixed-point; values are initialized/handled in `BLDC_controller_data.c`. Look for `<< 4` or `>> 16` shifts and _Fixdt suffixes.
- Auto-generated RTW code: the project includes MATLAB/Simulink auto-generated symbols (`rtP_Left`, `rtY_Left`, `rtU_Left`, `rtwtypes.h`). Do not edit generated interfaces unless you regenerate models.
- Debugging/diagnostics: conditional `#define DEBUG_SERIAL_USART2/3` and `DEBUG_SERIAL_PROTOCOL` produce printf output in `Src/main.c`. Use UART DMA transmit checks (`__HAL_DMA_GET_COUNTER`) when modifying feedback packets.

Important files to inspect when making changes
- `platformio.ini` — build matrix and flags.
- `Src/main.c` — application flow, variant handling, inputs/outputs, safety checks.
- `Src/BLDC_controller.c`, `Src/BLDC_controller_data.c`, `Inc/BLDC_controller.h` — core motor control and parameters.
- `Inc/config.h`, `Inc/defines.h` — feature flags and numeric limits.
- `Drivers/` and `Inc/stm32f1xx_hal_conf.h` — HAL and board-specific glue.

CI / repo automation
- Repo has a GitHub Actions workflow (badge referenced in `README.md`) — follow the same PlatformIO envs used in `platformio.ini` when reproducing CI locally.

What I couldn't discover automatically
- Exact serial monitor COM port for your machine (the `platformio.ini` example uses `COM5`). Use `pio device list` to find the right port.
- Any hardware-in-the-loop test harness. There are no unit tests in the repo; CI only validates build.

Quick editing rules for automated changes
- Preserve fixed-point scaling and autogenerated RTW symbols. If touching `BLDC_controller_data.c`, keep the numeric scaling consistent (search for `A2BIT_CONV`, shifts like `<< 4` and `>> 16`).
- When adding features that affect timing or ADC/DMA, carefully review `MX_TIM_Init`, `MX_ADC*_Init` and `HAL_NVIC` priorities in `Src` — timing is sensitive.

If anything above is unclear, tell me which file or workflow you want documented more precisely (for example: exact ST-Link upload steps for your Windows machine, or the mapping of timers/PWM channels to motor phases) and I'll expand this file.
